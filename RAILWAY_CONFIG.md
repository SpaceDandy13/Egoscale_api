# Railway部署配置建议

## 用户规模分析
- **用户数量**: 1,000 - 10,000 人
- **主要使用场景**:
  - 每日签到（每人每天1次）
  - 群聊发言获取积分（每人每天前3条消息）
  - 查看积分排行榜等查询操作

## 负载估算

### 峰值时段分析 (晚上8-10点)
- **活跃用户**: 20% (2,000人)
- **同时操作用户**: 10% (200人)
- **数据库并发连接**: 8-15个
- **每分钟数据库操作**: ~150次

### 资源需求

#### CPU使用
- **类型**: I/O密集型应用
- **推荐配置**: 2-4 vCPU
- **说明**: Discord bot主要处理网络请求和数据库I/O，CPU需求不高

#### 内存使用
- **基础内存**: 256MB (Python + discord.py)
- **连接池**: 50MB (18个数据库连接)
- **缓存和其他**: 200MB
- **推荐配置**: 512MB - 1GB

#### 存储需求
- **应用代码**: ~50MB
- **日志文件**: ~100MB/月
- **推荐配置**: 1GB (足够使用)

## Railway配置方案

### 方案一: 基础配置 (推荐)
```yaml
# 适合1,000-3,000用户
resources:
  cpu: "2000m"     # 2 vCPU
  memory: "512Mi"  # 512MB内存

database:
  postgres: "hobby"  # 20个连接上限
```

### 方案二: 增强配置
```yaml
# 适合5,000-10,000用户
resources:
  cpu: "4000m"     # 4 vCPU
  memory: "1Gi"    # 1GB内存

database:
  postgres: "pro"    # 100个连接上限
```

## 数据库连接池配置

当前优化后的配置：
- **最小连接数**: 5
- **最大连接数**: 18 (为Railway Hobby留余量)
- **连接超时**: 30秒
- **空闲回收**: 5分钟

## 监控指标

### 关键监控指标
1. **数据库连接池使用率**: 应保持在 < 80%
2. **响应时间**: 签到操作 < 500ms
3. **内存使用率**: < 80%
4. **错误率**: < 1%

### 日志监控
- 每30分钟记录连接池状态
- 连接不足时自动告警
- 数据库操作错误统计

## 扩容策略

### 何时需要升级
- **连接池使用率** 持续 > 80%
- **响应时间** 经常 > 1秒
- **内存使用率** > 80%
- **用户投诉** 操作缓慢

### 升级路径
1. **3,000用户以下**: Hobby计划 + 基础配置
2. **3,000-7,000用户**: Pro计划 + 增强配置
3. **7,000用户以上**: 考虑分片或读写分离

## 成本估算

### Railway Hobby计划
- **费用**: ~$5/月
- **适用**: 1,000-3,000活跃用户
- **限制**: 20个数据库连接

### Railway Pro计划  
- **费用**: ~$20/月
- **适用**: 3,000-10,000活跃用户
- **优势**: 100个数据库连接，更高性能

## 优化建议

### 即时优化
1. ✅ 已配置合适的连接池参数
2. ✅ 已添加连接池状态监控
3. 🔄 考虑添加Redis缓存热点查询
4. 🔄 定期清理过期数据

### 长期优化
1. 实现查询结果缓存
2. 添加慢查询监控
3. 考虑读写分离
4. 实现优雅降级机制

## 部署检查清单

### 环境变量
- [ ] `DATABASE_URL` - PostgreSQL连接字符串
- [ ] `TOKEN` - Discord Bot Token
- [ ] `PREFIX` - 命令前缀
- [ ] 其他必要的环境变量

### 部署后验证
- [ ] 连接池状态正常
- [ ] 签到功能正常
- [ ] 消息积分功能正常
- [ ] 数据库连接监控正常
- [ ] 日志输出正常

## 故障排查

### 常见问题
1. **连接池耗尽**: 检查长时间运行的查询
2. **内存不足**: 检查是否有内存泄漏
3. **响应缓慢**: 检查数据库查询性能
4. **频繁重启**: 检查错误日志和资源使用

### 紧急处理
- 临时增加资源配额
- 重启应用释放连接
- 检查并杀死异常连接